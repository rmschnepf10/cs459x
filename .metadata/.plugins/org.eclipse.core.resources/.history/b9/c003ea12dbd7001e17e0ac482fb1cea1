package assignment3;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.security.InvalidKeyException;
import java.security.KeyFactory;
import java.security.NoSuchAlgorithmException;
import java.security.PrivateKey;
import java.security.PublicKey;
import java.security.spec.InvalidKeySpecException;
import java.security.spec.PKCS8EncodedKeySpec;
import java.security.spec.X509EncodedKeySpec;

import javax.crypto.BadPaddingException;
import javax.crypto.Cipher;
import javax.crypto.IllegalBlockSizeException;
import javax.crypto.NoSuchPaddingException;
import javax.crypto.SecretKey;
import javax.crypto.spec.SecretKeySpec;

public class DecFile {
	String privateKeyFilePath;
	String publicKeyFilePath;
	String ciphertextFilePath;
	
	PublicKey publicKeyFromFile;
	PrivateKey privateKeyFromFile;
	byte[] cipherTextFromFile;
	
	public DecFile(String publicKeyFilePath, String privateKeyFilePath, String ciphertextFilePath) {
		this.publicKeyFilePath = publicKeyFilePath;
		this.privateKeyFilePath = privateKeyFilePath;
		this.ciphertextFilePath = ciphertextFilePath;
	}
	
	// HELPER METHOD, read the files: Parses the public key from a file into a
		// PublicKey
	public PublicKey readFileAndStorePublicKey()
			throws IOException, InvalidKeySpecException, NoSuchAlgorithmException {
		File filePublicKey = new File(publicKeyFilePath);
		FileInputStream fis = new FileInputStream(publicKeyFilePath);
		byte[] encodedPublicKey = new byte[(int) filePublicKey.length()];
		fis.read(encodedPublicKey);
		fis.close();
		
		X509EncodedKeySpec x509EncodedKeySpec = new X509EncodedKeySpec(encodedPublicKey);
		PublicKey publicKey = KeyFactory.getInstance("RSA").generatePublic(x509EncodedKeySpec);
		return publicKey;
	}

		// HELPER METHOD, read the files: Parses the private key from a file into a
		// PrivateKey
	public PrivateKey readFileAndStorePrivateKey()
		throws IOException, InvalidKeySpecException, NoSuchAlgorithmException {
		File filePrivateKey = new File(privateKeyFilePath);
		FileInputStream fis = new FileInputStream(privateKeyFilePath);
		byte[] encodedPrivateKey = new byte[(int) filePrivateKey.length()];
		fis.read(encodedPrivateKey);
		fis.close();
		
		PKCS8EncodedKeySpec pkcs8EncodedKeySpec = new PKCS8EncodedKeySpec(encodedPrivateKey);
		PrivateKey privateKey = KeyFactory.getInstance("RSA").generatePrivate(pkcs8EncodedKeySpec);
		return privateKey;
	}
	
	public byte[] readTheCipherFile() throws IOException {
		File fileCipher = new File(ciphertextFilePath);
		FileInputStream fis = new FileInputStream(ciphertextFilePath);
		cipherTextFromFile = new byte[(int)fileCipher.length()];
		fis.read(cipherTextFromFile);
		fis.close();
		return cipherTextFromFile;
	}
	
	public byte[] getAllTextDecrypted() throws NoSuchAlgorithmException, NoSuchPaddingException, InvalidKeyException, IllegalBlockSizeException, BadPaddingException {
		Cipher cipher = Cipher.getInstance("RSA");
		cipher.init(Cipher.DECRYPT_MODE, privateKeyFromFile);
		byte[] decryptedText = cipher.doFinal(cipherTextFromFile);
		return decryptedText;
	}
	
	public SecretKey getAESKey(byte[] decryptedText){
		byte[] AESKey = new byte[16];
		System.arraycopy(decryptedText, 0, AESKey, 0, 16);
		SecretKey key = new SecretKeySpec(AESKey, "AES");
		System.out.println("Decrypt encrypted AES key to get " + Integer.toString(AESKey.length ) + " bytes");

		return key;
	}
	
	public byte[] getCipherText(byte[] decryptedText) {
		
	}
	
	public void decryptTheCiphertext() throws InvalidKeySpecException, NoSuchAlgorithmException, IOException, InvalidKeyException, NoSuchPaddingException, IllegalBlockSizeException, BadPaddingException {
		//Read Public Key & Restore
	    publicKeyFromFile = readFileAndStorePublicKey();
	    
	    //Read Private Key & Restore
	    privateKeyFromFile = readFileAndStorePrivateKey();
	    
	    //get the cipher text and store it into bytes 
	    cipherTextFromFile = readTheCipherFile();
		System.out.println("Size of the ciphertext: " + Integer.toString(cipherTextFromFile.length ) + " bytes");

		byte[] decryptedText = getAllTextDecrypted();
		
		SecretKey AESKey = getAESKey(decryptedText);
	}
	
	public static void main(String[] args) throws InvalidKeySpecException, NoSuchAlgorithmException, IOException, InvalidKeyException, NoSuchPaddingException, IllegalBlockSizeException, BadPaddingException {
		if (args.length != 3) {
			System.out.println(
					"Usage: java EncFile <receiver's private key> <sender's public key> <ciphertext file>");
			return;
		}

		String publicKeyFilePath = args[0];
		String privateKeyFilePath = args[1];
		String ciphertextPath = args[2];

		DecFile decFile = new DecFile(publicKeyFilePath, privateKeyFilePath, ciphertextPath);
		
		decFile.decryptTheCiphertext();
	}
}
